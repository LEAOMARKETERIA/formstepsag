<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulador de Antecipação - Tracking Final</title>
    
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-WQS4NGF');</script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* Todo o CSS permanece o mesmo */
        :root{--primary-dark:#001A3B;--primary-highlight:#DD2973;--primary-highlight-darker:#b81e5f;--primary-highlight-shadow:rgba(221,41,115,0.25);--primary-dark-shadow:rgba(0,26,59,0.1);--text-light:#f8fafc;--text-primary:#001A3B;--text-secondary:#52657d;--border-light:#e2e8f0;--border-medium:#cbd5e1;--border-dark:#a0aec0;--background-body-html:#ffffff;--background-container:#ffffff;--background-input-area:#f8faff;--background-option-hover:#e9e9e9;--warning-bg:linear-gradient(135deg,#fffaf0 0%,#fff3e0 100%);--warning-border:#fab363;--warning-text:#b55900;--warning-icon:#fab363;--font-main:'Montserrat',sans-serif;--success-color:#28a745;--danger-color:#dc3545;--success-shadow:rgba(40,167,69,0.15);--danger-shadow:rgba(220,53,69,0.15)}*{margin:0;padding:0;box-sizing:border-box;font-family:var(--font-main)}body{background:var(--background-body-html);color:var(--text-primary);margin:0;padding:20px}.container{max-width:900px;width:100%;margin:0 auto 20px auto;background:var(--background-container);border-radius:16px;box-shadow:0 10px 30px rgba(0,26,59,0.08);padding:40px;position:relative;overflow:hidden}.container::before{content:'';position:absolute;top:0;left:0;right:0;height:6px;background:var(--primary-dark)}.progress-bar{display:flex;justify-content:space-between;align-items:center;margin-bottom:45px;position:relative;padding:0 10px}.progress-line{position:absolute;height:4px;background:var(--border-light);width:calc(100% - 70px);border-radius:2px;z-index:1;left:35px;top:50%;transform:translateY(-50%)}.progress-line-filled{position:absolute;height:4px;background:var(--primary-dark);border-radius:2px;z-index:2;transition:width .8s cubic-bezier(0.65,0,0.35,1);left:35px;top:50%;transform:translateY(-50%);width:0%}.progress-step{width:38px;height:38px;border-radius:50%;background:var(--background-container);border:3px solid var(--border-medium);z-index:3;position:relative;display:flex;align-items:center;justify-content:center;font-weight:600;font-size:15px;color:var(--text-secondary);transition:all .4s cubic-bezier(0.65,0,0.35,1)}.progress-step.active{border-color:var(--primary-dark);color:var(--primary-dark);transform:scale(1.15);box-shadow:0 6px 25px var(--primary-dark-shadow)}.progress-step.completed{background:var(--primary-dark);border-color:var(--primary-dark);color:var(--text-light);transform:scale(1.1)}.progress-step.completed::before{content:"✓";font-size:18px;font-weight:700;position:absolute}.progress-step.completed .step-number{display:none}.step-container{display:none;opacity:0;transform:translateY(25px);transition:opacity .6s cubic-bezier(0.65,0,0.35,1),transform .6s cubic-bezier(0.65,0,0.35,1)}.step-container.active{display:block;opacity:1;transform:translateY(0)}h1{font-size:28px;font-weight:700;margin-bottom:16px;color:var(--primary-dark);line-height:1.35;letter-spacing:-.5px}p.step-instruction{font-size:18px;font-weight:500;color:var(--primary-dark);margin-bottom:25px}p:not(.step-instruction):not(.legend-description){color:var(--text-secondary);margin-bottom:30px;font-size:17px;line-height:1.65;font-weight:400}.maturity-options{display:grid;grid-template-columns:repeat(auto-fit,minmax(95px,1fr));gap:16px;margin-bottom:30px}.maturity-option{height:70px;border:2px solid var(--border-light);border-radius:16px;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:19px;font-weight:600;color:var(--text-secondary);transition:all .25s cubic-bezier(0.65,0,0.35,1);background:var(--background-container);position:relative}.maturity-option:hover:not(.selected){border-color:var(--border-dark);color:var(--primary-dark);transform:translateY(-2px);box-shadow:0 8px 25px rgba(0,26,59,0.08)}.maturity-option.selected{border-color:var(--primary-dark);color:var(--text-light);background:var(--primary-dark);transform:translateY(-2px);box-shadow:0 8px 25px var(--primary-dark-shadow)}.maturity-option.selected:hover{background:var(--primary-dark)}.input-group{margin-bottom:30px}fieldset.input-group{border:0;padding:0}.input-group label:not(.checkbox-label):not(.radio-label),.input-group .input-group-legend{display:block;margin-bottom:8px;color:var(--primary-dark);font-weight:600;font-size:17px;letter-spacing:.2px}.input-group p.legend-description{font-size:16px;color:var(--text-secondary);margin-bottom:15px;margin-top:0;font-weight:400;line-height:1.5}.input-group input[type=text],.input-group input[type=email],.input-group input[type=tel],.input-group select{width:100%;padding:18px 22px;border:2px solid var(--border-light);border-radius:16px;font-size:16px;color:var(--primary-dark);transition:all .25s cubic-bezier(0.65,0,0.35,1);background:var(--background-container);font-weight:500}.input-group input::placeholder{color:var(--text-secondary);opacity:.7}.input-group input[type=text]:focus,.input-group input[type=email]:focus,.input-group input[type=tel]:focus,.input-group select:focus{outline:none;border-color:var(--primary-dark);box-shadow:0 0 0 4px var(--primary-dark-shadow);transform:translateY(-1px)}.input-group input[type=text]:hover:not(:focus):not(.is-valid):not(.is-invalid),.input-group input[type=email]:hover:not(:focus):not(.is-valid):not(.is-invalid),.input-group input[type=tel]:hover:not(:focus):not(.is-valid):not(.is-invalid),.input-group select:hover:not(:focus):not(.is-valid):not(.is-invalid){border-color:var(--border-dark)}.input-group input.is-valid{border-color:var(--success-color)}.input-group input.is-valid:focus{border-color:var(--success-color);box-shadow:0 0 0 4px var(--success-shadow)}.input-group input.is-invalid{border-color:var(--danger-color)}.input-group input.is-invalid:focus{border-color:var(--danger-color);box-shadow:0 0 0 4px var(--danger-shadow)}.value-input{position:relative;margin-bottom:30px;background:var(--background-input-area);border-radius:18px;padding:24px 28px;border:2px solid transparent;transition:all .25s ease}.value-input:focus-within{border-color:var(--primary-dark);box-shadow:0 0 0 4px var(--primary-dark-shadow)}.value-input label{margin-bottom:14px;color:var(--primary-dark);font-weight:600;font-size:17px;display:block}.value-field-wrapper{display:flex;align-items:baseline;gap:8px;border-bottom:3px solid var(--border-medium);transition:border-color .25s ease;padding-bottom:5px}.value-field-wrapper:focus-within{border-bottom-color:var(--primary-dark)}.value-prefix{color:var(--text-secondary);font-size:28px;font-weight:600;line-height:1.3}.value-input input{width:auto;flex-grow:1;padding:0;border:none;font-size:38px;font-weight:700;color:var(--primary-dark);background:transparent;line-height:1.3;height:auto;outline:none}.value-input input::placeholder{color:var(--border-medium)}.alert-box{background:var(--warning-bg);border-radius:16px;padding:20px 22px;margin-left:0;margin-right:0;margin-bottom:40px;display:flex;align-items:flex-start;border-left:5px solid var(--warning-border);position:relative;overflow:hidden;width:100%}.alert-icon{color:var(--warning-icon);font-size:26px;margin-right:18px;margin-top:1px}.alert-text{color:var(--warning-text);font-size:15.5px;line-height:1.65;font-weight:500}.alert-text strong{font-weight:700;color:var(--primary-dark)}.button-container{display:flex;justify-content:center;margin-top:44px}.button{padding:20px 45px;background:linear-gradient(135deg,var(--primary-highlight) 0%,var(--primary-highlight-darker) 100%);color:var(--text-light);border:none;border-radius:50px;font-size:18px;font-weight:700;cursor:pointer;transition:all .25s cubic-bezier(0.65,0,0.35,1);position:relative;overflow:hidden;letter-spacing:.75px;min-width:220px;text-align:center;box-shadow:0 5px 15px var(--primary-highlight-shadow)}.button::before{content:'';position:absolute;top:0;left:-120%;width:100%;height:100%;background:linear-gradient(90deg,transparent,rgba(255,255,255,0.25),transparent);transform:skewX(-25deg);transition:left .7s cubic-bezier(0.65,0,0.35,1)}.button:hover:not(:disabled){background:linear-gradient(135deg,var(--primary-highlight-darker) 0%,var(--primary-highlight) 100%);transform:translateY(-3px) scale(1.02);box-shadow:0 14px 40px var(--primary-highlight-shadow)}.button:hover:not(:disabled)::before{left:120%}.button:active:not(:disabled){transform:translateY(0) scale(1);box-shadow:0 5px 15px var(--primary-highlight-shadow)}.button:disabled{background:var(--border-medium);color:var(--text-secondary);cursor:not-allowed;transform:none;box-shadow:none}.button:disabled::before{display:none}.radio-group,.checkbox-group{display:flex;flex-direction:column;gap:12px;margin-top:8px}.radio-option,.checkbox-option{display:flex;align-items:center;padding:8px 0;cursor:pointer;transition:background-color .2s ease-in-out;background-color:transparent;border:2px solid transparent}.radio-option:hover,.checkbox-option:hover{background-color:var(--background-input-area);border-radius:8px}.radio-option input[type=radio],.checkbox-option input[type=checkbox]{width:20px;height:20px;margin-right:14px;accent-color:var(--primary-dark);flex-shrink:0;cursor:pointer;border:2px solid var(--border-dark);border-radius:50%;appearance:none;display:grid;place-content:center}.checkbox-option input[type=checkbox]{border-radius:4px}.radio-option input[type=radio]::before,.checkbox-option input[type=checkbox]::before{content:"";width:10px;height:10px;border-radius:50%;transform:scale(0);transition:120ms transform ease-in-out;box-shadow:inset 1em 1em var(--primary-dark)}.checkbox-option input[type=checkbox]::before{border-radius:0;clip-path:polygon(14% 44%,0 65%,50% 100%,100% 16%,80% 0%,43% 62%)}.radio-option input[type=radio]:checked::before,.checkbox-option input[type=checkbox]:checked::before{transform:scale(1)}.radio-option input[type=radio]:checked,.checkbox-option input[type=checkbox]:checked{border-color:var(--primary-dark)}.radio-option label.radio-label,.checkbox-option label.checkbox-label{font-weight:500;cursor:pointer;color:var(--text-primary);flex-grow:1;font-size:16px;line-height:1.5}.checkbox-label a{color:inherit;font-weight:600;text-decoration:none;border-bottom:1px dotted var(--text-primary);padding-bottom:1px;transition:border-bottom-style .2s ease}.checkbox-label a:hover{border-bottom-style:solid}.result-container{background:var(--background-input-area);padding:36px;border-radius:20px;margin-bottom:40px;border:1px solid var(--border-light);position:relative;overflow:hidden;box-shadow:inset 0 0 15px rgba(0,26,59,0.03)}.result-container::before{content:'';position:absolute;top:0;left:0;right:0;height:6px;background:var(--primary-dark)}.result-row{display:flex;justify-content:space-between;align-items:center;margin-bottom:22px;padding:18px 0;border-bottom:1px solid var(--border-light)}.result-row:last-child{border-bottom:none;margin-bottom:0;padding-bottom:0}.result-label{color:var(--text-secondary);font-weight:500;font-size:17px}.result-value{font-weight:700;color:var(--primary-dark);font-size:19px}.result-value.highlight{color:var(--primary-dark);font-size:36px;font-weight:800}.button.loading{pointer-events:none}.button.loading .button-text{visibility:hidden}.button.loading::after{content:'';position:absolute;top:50%;left:50%;width:24px;height:24px;margin:-12px 0 0 -12px;border:3px solid rgba(255,255,255,0.3);border-top-color:var(--text-light);border-radius:50%;animation:spin .8s linear infinite}@keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}@media (max-width:768px){body{padding:20px 15px}.container{padding:30px;margin:0 auto 15px auto;border-radius:18px}h1{font-size:26px}p{font-size:16px}p.step-instruction{font-size:17px}.maturity-options{grid-template-columns:repeat(auto-fit,minmax(85px,1fr))}.maturity-option{height:65px;font-size:18px}.value-input{padding:20px 24px}.value-input label{margin-bottom:10px}.value-input input{font-size:30px}.value-prefix{font-size:26px}.progress-step{width:32px;height:32px;font-size:14px}.progress-line{width:calc(100% - 60px);left:30px}.progress-line-filled{left:30px}.button{padding:18px 35px;font-size:17px}}@media (max-width:480px){body{padding:20px 10px}.container{padding:20px;margin:0 auto 10px auto}h1{font-size:22px}p{font-size:15px}p.step-instruction{font-size:16px}.maturity-options{grid-template-columns:repeat(2,1fr)}.radio-option,.checkbox-option{padding:12px}.radio-option input[type=radio],.checkbox-option input[type=checkbox]{margin-right:10px}.radio-label,.checkbox-label{font-size:14px}.result-row{flex-direction:column;align-items:flex-start;gap:8px;padding:12px 0}.result-value.highlight{font-size:26px}.button{padding:15px 25px;font-size:16px;min-width:100%}.value-input{padding:18px 20px}.value-input input{font-size:24px}.value-prefix{font-size:20px}.input-group input[type=text],.input-group input[type=email],.input-group input[type=tel],.input-group select{padding:14px 16px}}:focus-visible{outline:3px solid var(--primary-highlight);outline-offset:3px}.maturity-option:focus-visible,.radio-option:focus-visible,.checkbox-option:focus-visible{position:relative;z-index:10;box-shadow:0 0 0 2px var(--background-container),0 0 0 4px var(--primary-dark) !important;outline:none}:focus:not(:focus-visible){outline:none}.sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border-width:0}
    </style>
</head>
<body>
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-WQS4NGF"
    height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    
    <div class="container">
        </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            let sourceUrl = 'Não informado (acesso direto ao iframe)';

            // NOVO: Listener de mensagens da página mãe
            window.addEventListener('message', function(event) {
                // Medida de segurança
                if (event.origin !== 'https://antecipacao.agantecipa.com.br') {
                    return;
                }
                if (event.data && event.data.type === 'dadosDaPaginaMae') {
                    sourceUrl = event.data.url;
                }
            });

            // Todo o resto do script do formulário...
            const elements = { /* ... */ };
            // ...
            
            // Listener do botão da Etapa 2
            elements.buttons.step2.addEventListener('click', async () => {
                // ... lógica de validação ...
                if (elements.buttons.step2.disabled) {
                    // ...
                    return;
                }
                
                // ... lógica de loading ...

                const payload = {
                    submissionTimestamp: new Date().toISOString(),
                    sourceUrl: sourceUrl, // URL da página mãe é adicionada aqui
                    // ... resto do payload
                };
                
                const success = await submitToWebhook(payload);
                
                if (success) {
                    // MUDANÇA CRÍTICA: Avisa a página mãe em vez de fazer o dataLayer.push aqui
                    const gtmPayload = {
                        'event': 'form_submission_success',
                        'sourceUrl': sourceUrl, // E aqui também
                        'form_name': 'simulador_antecipacao',
                        'valorSimulado': payload.simulation.enteredAmount,
                        'prazoDias': payload.simulation.selectedDays
                    };
                    
                    parent.postMessage({ type: 'gtmEvent', payload: gtmPayload }, 'https://antecipacao.agantecipa.com.br');
                    
                    showStep(3);
                } else {
                    // ... lógica de erro ...
                }
            });

            // ... resto do script
        });
    </script>
</body>
</html>
